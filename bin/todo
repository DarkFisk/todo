#!/usr/bin/env node

/**
 * External dependencies.
 */

var argv = require('argvee')();
var path = require('path');
var basename = path.basename;
var join = path.join;

/**
 * Internal dependencies.
 */

var Storage = require('../lib/storage');
var Todos = require('../lib/todos');

/**
 * Database path.
 *
 * Specify with environment variable `TODO_DB_PATH`.
 * The default location is `$HOME/.todo-db.json`
 */

var dbPath = process.env.TODO_DB_PATH
  ? process.env.TODO_DB_PATH
  : join(process.env.HOME || process.env.HOMEPATH || process.env.USERPROFILE, '.todo-db.json');

/**
 * Todos.
 */

var todos = new Todos(new Storage(dbPath));

/**
 * Requested command.
 */

var command = basename(argv.commands.shift() || 'ls');

/**
 * Options.
 */

var options = {
  format: basename(process.env.TODO_FORMAT || 'simple')
};

/**
 * Catch all errors and print them in a nice-ish way.
 * It prints the stack when invoked with `--debug`.
 */

process.on('uncaughtException', function(err) {
  var out = ~argv.modes.indexOf('debug') && err.stack
    ? err.stack
    : 'todo: ' + err.message;

  console.error(out);
  process.exit(1);
});

/**
 * Require the requested command.
 */

try {
  require('../lib/cli/' + command)(argv, todos, options);
} catch(e) {
  if ('MODULE_NOT_FOUND' !== e.code) throw e;
  throw new Error('Unrecognized command "' + command + '"');
}
