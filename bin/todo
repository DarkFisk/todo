#!/usr/bin/env node

/**
 * External dependencies.
 */

var argv = require('argvee')();
var basename = require('path').basename;

/**
 * Internal dependencies.
 */

var Storage = require('../lib/storage');
var Todos = require('../lib/todos');

/**
 * Todos.
 */

var todos = new Todos(new Storage('/tmp/todos.txt'));

/**
 * Requested command.
 */

var command = basename(argv.commands.shift() || 'help');

/**
 * Options.
 */

var options = {
  format: basename(process.env.TODO_FORMAT || 'simple')
};

/**
 * Catch all errors and print them in a nice-ish way.
 * It prints the stack when invoked with `--debug`.
 */

process.on('uncaughtException', function(err) {
  var out = ~argv.modes.indexOf('debug') && err.stack
    ? err.stack
    : 'todo: ' + err.message;

  console.error(out);
  process.exit(1);
});

try {
  require('../lib/cli/' + command)(argv, todos, options);
} catch(e) {
  if ('MODULE_NOT_FOUND' !== e.code) throw e;
  throw new Error('Unrecognized command "' + command + '"');
}
